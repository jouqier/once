# –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞

## –ë–∞–∑–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã

### 1. –ö–æ–º–∞–Ω–¥–∞ /start –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç:**
```
/start
```

**–ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç:**
```
üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ñ–∏–ª—å–º–æ–≤ –∏ —Å–µ—Ä–∏–∞–ª–æ–≤.

üé¨ –û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!

[–ö–Ω–æ–ø–∫–∞: üé¨ –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ]
```

### 2. –ö–æ–º–∞–Ω–¥–∞ /start —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º —Ñ–∏–ª—å–º–∞

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Å—ã–ª–∫—É:**
```
https://t.me/onceappbot?start=movie_550
```

**–ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç:**
```
[–ü–æ—Å—Ç–µ—Ä Fight Club]

üé¨ Fight Club
‚≠ê 8.4/10

An insomniac office worker and a devil-may-care soap maker form an underground fight club that evolves into much more.

[–ö–Ω–æ–ø–∫–∞: ‚ñ∂Ô∏è –û—Ç–∫—Ä—ã—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏]
```

### 3. Inline query –¥–ª—è —à–∞—Ä–∏–Ω–≥–∞

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ª—é–±–æ–º —á–∞—Ç–µ –Ω–∞–±–∏—Ä–∞–µ—Ç:**
```
@onceappbot share_movie_550
```

**–ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  [–ü–æ—Å—Ç–µ—Ä Fight Club]        ‚îÇ
‚îÇ                             ‚îÇ
‚îÇ  Fight Club                 ‚îÇ
‚îÇ  ‚≠ê 8.4/10 ‚Ä¢ 1999          ‚îÇ
‚îÇ                             ‚îÇ
‚îÇ  An insomniac office...     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —á–∞—Ç:**
```
üé¨ Fight Club (1999)
‚≠ê 8.4/10

An insomniac office worker and a devil-may-care soap maker form an underground fight club that evolves into much more.

[–ö–Ω–æ–ø–∫–∞: ‚ñ∂Ô∏è –û—Ç–∫—Ä—ã—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏]
```

## –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –ø—Ä–∏–º–µ—Ä—ã

### –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ñ–∏–ª—å–º–∞

```javascript
// –í index.js, —Ñ—É–Ω–∫—Ü–∏—è bot.start()

const message = `
üé¨ ${title}
‚≠ê ${rating}
üìÖ ${year}
‚è±Ô∏è ${runtime} –º–∏–Ω
üé≠ ${genres.join(', ')}

${overview}
`;
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫

```javascript
const keyboard = Markup.inlineKeyboard([
    [Markup.button.webApp('‚ñ∂Ô∏è –û—Ç–∫—Ä—ã—Ç—å', `${WEB_APP_URL}?id=${mediaId}&type=${mediaType}`)],
    [Markup.button.url('üé¨ TMDB', `https://www.themoviedb.org/movie/${mediaId}`)],
    [Markup.button.url('üçø IMDb', `https://www.imdb.com/title/${imdbId}`)]
]);
```

### Inline query —Å –ø–æ–∏—Å–∫–æ–º

```javascript
bot.on('inline_query', async (ctx) => {
    const query = ctx.inlineQuery.query;
    
    // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å share_ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∏–ª—å–º
    if (query.startsWith('share_')) {
        // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥
    }
    // –ò–Ω–∞—á–µ - –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
    else if (query.length > 2) {
        const searchResults = await searchMovies(query);
        const results = searchResults.map(movie => ({
            type: 'article',
            id: `movie_${movie.id}`,
            title: movie.title,
            description: `‚≠ê ${movie.vote_average}/10`,
            thumb_url: `https://image.tmdb.org/t/p/w200${movie.poster_path}`,
            input_message_content: {
                message_text: `üé¨ ${movie.title}\n‚≠ê ${movie.vote_average}/10`
            },
            reply_markup: {
                inline_keyboard: [[
                    { text: '‚ñ∂Ô∏è –û—Ç–∫—Ä—ã—Ç—å', url: generateDirectLink('movie', movie.id) }
                ]]
            }
        }));
        
        await ctx.answerInlineQuery(results);
    }
});
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –∫–Ω–æ–ø–æ–∫

```javascript
// –î–æ–±–∞–≤–ª—è–µ–º callback –∫–Ω–æ–ø–∫—É
const keyboard = Markup.inlineKeyboard([
    [Markup.button.webApp('‚ñ∂Ô∏è –û—Ç–∫—Ä—ã—Ç—å', directLink)],
    [Markup.button.callback('‚≠ê –û—Ü–µ–Ω–∏—Ç—å', `rate_${mediaType}_${mediaId}`)]
]);

// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º callback
bot.action(/rate_(.+)_(.+)/, async (ctx) => {
    const [, mediaType, mediaId] = ctx.match;
    
    await ctx.answerCbQuery('–û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –æ—Ü–µ–Ω–∫–∏!');
    
    // –ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å —Ñ–æ—Ä–º–æ–π –æ—Ü–µ–Ω–∫–∏
    await ctx.editMessageReplyMarkup({
        inline_keyboard: [[
            { 
                text: '‚≠ê –û—Ü–µ–Ω–∏—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏', 
                url: `${WEB_APP_URL}?id=${mediaId}&type=${mediaType}&action=rate`
            }
        ]]
    });
});
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —à–∞—Ä–∏–Ω–≥–∞

```javascript
const db = require('./database'); // –í–∞—à–∞ –ë–î

bot.on('inline_query', async (ctx) => {
    const userId = ctx.from.id;
    const query = ctx.inlineQuery.query;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    await db.saveInlineQuery({
        userId,
        query,
        timestamp: new Date()
    });
    
    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
});

// –í—ã–±–æ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
bot.on('chosen_inline_result', async (ctx) => {
    const userId = ctx.from.id;
    const resultId = ctx.chosenInlineResult.result_id;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–µ–ª–∏–ª—Å—è
    await db.saveShare({
        userId,
        mediaId: resultId,
        timestamp: new Date()
    });
});
```

### –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏

```javascript
bot.start(async (ctx) => {
    const userId = ctx.from.id;
    
    // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userHistory = await db.getUserHistory(userId);
    
    if (userHistory.length > 0) {
        await ctx.reply(
            `üëã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º!\n\n` +
            `üìä –í—ã –ø–æ—Å–º–æ—Ç—Ä–µ–ª–∏ ${userHistory.length} —Ñ–∏–ª—å–º–æ–≤`,
            Markup.inlineKeyboard([
                [Markup.button.webApp('üé¨ –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', WEB_APP_URL)]
            ])
        );
    } else {
        // –û–±—ã—á–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    }
});
```

## Webhook –¥–ª—è production

```javascript
const express = require('express');
const app = express();

// Webhook endpoint
app.use(bot.webhookCallback('/webhook'));

// Health check
app.get('/health', (req, res) => {
    res.send('OK');
});

// –ó–∞–ø—É—Å–∫ —Å webhook
const PORT = process.env.PORT || 3000;
const WEBHOOK_URL = process.env.WEBHOOK_URL;

if (WEBHOOK_URL) {
    bot.telegram.setWebhook(`${WEBHOOK_URL}/webhook`);
    app.listen(PORT, () => {
        console.log(`‚úÖ Webhook –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
    });
} else {
    // Polling –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    bot.launch();
    console.log('‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –≤ —Ä–µ–∂–∏–º–µ polling');
}
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```javascript
const winston = require('winston');

const logger = winston.createLogger({
    level: 'info',
    format: winston.format.json(),
    transports: [
        new winston.transports.File({ filename: 'error.log', level: 'error' }),
        new winston.transports.File({ filename: 'combined.log' })
    ]
});

// –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ inline –∑–∞–ø—Ä–æ—Å—ã
bot.on('inline_query', async (ctx) => {
    logger.info('Inline query', {
        userId: ctx.from.id,
        username: ctx.from.username,
        query: ctx.inlineQuery.query
    });
    
    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
});

// –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
bot.catch((err, ctx) => {
    logger.error('Bot error', {
        error: err.message,
        stack: err.stack,
        update: ctx.update
    });
});
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```javascript
// test/bot.test.js
const { Telegraf } = require('telegraf');
const { getMediaData } = require('../index');

describe('Bot functions', () => {
    test('getMediaData returns movie data', async () => {
        const data = await getMediaData('movie', 550);
        expect(data).toHaveProperty('title');
        expect(data.title).toBe('Fight Club');
    });
    
    test('generates correct direct link', () => {
        const link = generateDirectLink('movie', 550);
        expect(link).toBe('https://t.me/onceappbot/app?startapp=movie_550');
    });
});
```

## –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–æ—Ç–µ

```javascript
bot.command('info', async (ctx) => {
    const botInfo = await ctx.telegram.getMe();
    await ctx.reply(
        `ü§ñ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ:\n\n` +
        `–ò–º—è: ${botInfo.first_name}\n` +
        `Username: @${botInfo.username}\n` +
        `ID: ${botInfo.id}`
    );
});
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```javascript
bot.command('stats', async (ctx) => {
    const stats = await db.getStats();
    await ctx.reply(
        `üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n\n` +
        `üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${stats.users}\n` +
        `üé¨ –§–∏–ª—å–º–æ–≤ –ø–æ–¥–µ–ª–∏–ª–∏—Å—å: ${stats.shares}\n` +
        `üîç Inline –∑–∞–ø—Ä–æ—Å–æ–≤: ${stats.queries}`
    );
});
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Telegraf –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://telegraf.js.org/)
- [Telegram Bot API](https://core.telegram.org/bots/api)
- [TMDB API](https://developers.themoviedb.org/3)
