# Настройка прямых ссылок для Telegram Mini App

## Важно: Настройка Web App в BotFather

Для автоматического открытия Mini App по прямым ссылкам нужно настроить Web App в BotFather:

### Шаг 1: Создайте Web App

1. Откройте [@BotFather](https://t.me/BotFather)
2. Отправьте команду `/newapp`
3. Выберите вашего бота из списка
4. Отправьте **название приложения** (например, "Movie App")
5. Отправьте **описание** приложения
6. Отправьте **фото** для приложения (квадратное, минимум 640x640px)
7. Отправьте **GIF** для демонстрации (опционально, можно пропустить через /empty)
8. Отправьте **URL вашего Mini App** (например, `https://your-app.com`)
9. Отправьте **короткое имя** (short name) - только латиница и цифры, без пробелов
   - Например: `movieapp` или `app`
   - Это имя будет использоваться в ссылках: `t.me/your_bot/movieapp`

### Шаг 2: Настройте переменные окружения

В файле `.env` укажите:

```env
VITE_BOT_USERNAME=your_bot_username
VITE_APP_SHORT_NAME=movieapp  # Короткое имя из шага 1.9
```

Если не указать `VITE_APP_SHORT_NAME`, будет использоваться `app` по умолчанию.

## Быстрый старт

### 1. Настройте переменные окружения

В файле `.env` добавьте:

```env
VITE_BOT_USERNAME=your_bot_username
VITE_APP_SHORT_NAME=app
```

**Где взять значения:**
- `VITE_BOT_USERNAME` - имя бота без `@` (например, `MyMovieBot`)
- `VITE_APP_SHORT_NAME` - короткое имя из BotFather (шаг 1.9 выше)

### 2. Соберите и разверните

```bash
npm run build
```

Разверните собранное приложение на вашем хостинге.

### 3. Проверьте работу

1. Откройте ваш Mini App в Telegram
2. Откройте любой фильм или сериал
3. Нажмите кнопку "Поделиться" (в правом верхнем углу постера)
4. Выберите "Поделиться в Telegram"
5. Отправьте ссылку себе или другу
6. Откройте ссылку - приложение должно открыться с деталями фильма

## Как это работает

### Формат ссылок

Приложение генерирует Direct Link ссылки:

```
https://t.me/your_bot_username/app?startapp=movie_550
https://t.me/your_bot_username/app?startapp=tv_1396
```

Где:
- `your_bot_username` - имя вашего бота из `.env`
- `app` - короткое имя приложения (из `VITE_APP_SHORT_NAME`)
- `startapp` - параметр для передачи данных в Mini App
- `movie_550` или `tv_1396` - тип контента и ID

Эти ссылки **автоматически открывают Mini App** без необходимости кода на стороне бота!

### Обработка при открытии

Когда пользователь открывает Direct Link:

1. Telegram **автоматически открывает Mini App** (не чат с ботом!)
2. Приложение получает параметр из URL (`?startapp=...`) или `TG.initDataUnsafe.start_param`
3. Парсит параметр: `movie_550` → `{ type: 'movie', id: 550 }`
4. Автоматически открывает страницу с деталями фильма

**Никакого кода на стороне бота не требуется!** Direct Link работает автоматически.

## Fallback для веб-версии

Если `VITE_BOT_USERNAME` не настроен, приложение будет генерировать обычные веб-ссылки:

```
https://your-app.com/?id=550&type=movie
```

Эти ссылки работают в браузере, но не открывают Mini App в Telegram.

## Проверка настройки

### В коде

```javascript
import { shareLinkService } from './services/share-link.js';

// Проверьте, какой тип ссылок генерируется
const link = shareLinkService.generateShareLink(550, 'movie');
console.log(link);

// Если настроено правильно, увидите:
// https://t.me/your_bot/app?startapp=movie_550

// Если не настроено:
// https://your-app.com/?id=550&type=movie
```

### В браузере

1. Откройте консоль разработчика (F12)
2. Выполните:
   ```javascript
   console.log(import.meta.env.VITE_BOT_USERNAME)
   ```
3. Должно вывести имя вашего бота

## Troubleshooting

### Ссылки открывают чат с ботом вместо Mini App

**Проблема:** При открытии ссылки открывается чат с ботом, а не Mini App.

**Решение:**
1. Убедитесь, что вы создали Web App в BotFather (команда `/newapp`)
2. Проверьте, что `VITE_APP_SHORT_NAME` совпадает с коротким именем из BotFather
3. Проверьте формат ссылки: должно быть `t.me/bot/app?startapp=...`, а не `t.me/bot?start=...`
4. Пересоберите приложение: `npm run build`

### Приложение не открывает нужный фильм

**Проблема:** Mini App открывается, но показывает главную страницу.

**Решение:**
1. Проверьте консоль на ошибки
2. Убедитесь, что формат `startapp` правильный: `movie_123` или `tv_456`
3. Проверьте, что ID фильма существует в TMDB

### Ссылки генерируются в старом формате

**Проблема:** Генерируются ссылки `?id=123&type=movie` вместо `startapp=movie_123`.

**Решение:**
1. Проверьте `.env` файл
2. Убедитесь, что переменная называется именно `VITE_BOT_USERNAME`
3. Перезапустите dev сервер или пересоберите приложение

## Дополнительно

### Тестирование локально

Для локального тестирования можно использовать веб-ссылки:

```bash
npm run dev

# Откройте в браузере:
http://localhost:5173/?id=550&type=movie
```

### Аналитика

Для отслеживания переходов по ссылкам можно добавить дополнительные параметры:

```javascript
// В будущем можно расширить:
const link = shareLinkService.generateShareLink(550, 'movie');
// Добавить utm метки или другие параметры
```

### Кастомизация

Если нужен другой формат ссылок, отредактируйте `src/services/share-link.js`:

```javascript
generateTelegramLink(mediaId, mediaType) {
    // Ваш кастомный формат
    return `https://t.me/${botUsername}/app?startapp=custom_${mediaType}_${mediaId}`;
}
```

Не забудьте обновить парсинг в `src/main.js`.
