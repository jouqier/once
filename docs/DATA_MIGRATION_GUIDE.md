# Руководство по миграции данных

## Обзор

Система миграции данных обеспечивает совместимость при изменении структуры localStorage между версиями приложения. Все данные пользователей сохраняются и автоматически конвертируются в новый формат.

## Версии

### Версия 1.0 (старая)
- Структура `movies` была объектом с ключами-ID фильмов
- Отсутствовал список `watching` для фильмов
- Возможны были некорректные данные в `tvShows.episodes`

### Версия 1.1 (текущая)
- Структура `movies` теперь содержит массивы: `want`, `watched`, `watching`
- Отзывы вынесены в отдельный объект `movies.reviews`
- Добавлена валидация всех данных при загрузке
- Автоматическое исправление некорректных структур

## Как работает миграция

1. **Автоматическая миграция при загрузке**
   - При инициализации `UserDataStore` проверяется версия данных
   - Если версия старая, автоматически применяются все необходимые миграции
   - Данные сохраняются в новом формате

2. **Валидация данных**
   - Все методы работы с данными проверяют корректность структуры
   - Некорректные данные автоматически исправляются
   - Логируются предупреждения о найденных проблемах

3. **Защита от потери данных**
   - Все данные пользователя конвертируются, а не удаляются
   - При ошибках создается чистое хранилище
   - Возможность создания резервных копий

## Утилита диагностики

В консоли браузера доступна утилита `dataRepair` для диагностики и ремонта данных:

### Команды

```javascript
// Проверить состояние данных
dataRepair.diagnose()

// Исправить проблемы (создает резервную копию)
dataRepair.repair()

// Создать резервную копию
dataRepair.backup()

// Показать список резервных копий
dataRepair.listBackups()

// Восстановить из резервной копии
dataRepair.restore('user_data_123_backup_1699999999999')

// Показать справку
dataRepair.help()
```

### Пример использования

```javascript
// 1. Проверяем данные пользователя
dataRepair.diagnose()

// Если обнаружены проблемы:
// 2. Создаем резервную копию (опционально, repair() делает это автоматически)
dataRepair.backup()

// 3. Исправляем проблемы
dataRepair.repair()

// 4. Перезагружаем страницу
location.reload()
```

## Добавление новых миграций

Если нужно изменить структуру данных в будущем:

1. **Обновите версию** в `data-migration.js`:
   ```javascript
   this.CURRENT_VERSION = '1.2';
   ```

2. **Добавьте метод миграции**:
   ```javascript
   _migrateFrom1_1(data) {
       console.log('Применяется миграция 1.1 → 1.2');
       const migrated = { ...data };
       
       // Ваши изменения структуры данных
       
       return migrated;
   }
   ```

3. **Зарегистрируйте миграцию**:
   ```javascript
   this.migrations = {
       '1.0': this._migrateFrom1_0.bind(this),
       '1.1': this._migrateFrom1_1.bind(this),
       '1.2': null // текущая версия
   };
   ```

4. **Обновите метод migrate()** для применения новой миграции:
   ```javascript
   if (dataVersion === '1.1') {
       migratedData = this._migrateFrom1_1(migratedData);
   }
   ```

## Структура данных v1.1

```javascript
{
  version: "1.1",
  userId: "123456",
  movies: {
    want: [
      { id: 123, title: "Movie", poster_path: "/path.jpg", release_date: "2024-01-01" }
    ],
    watched: [...],
    watching: [...],
    reviews: {
      "123": { rating: 5, review: "Great!", date: "2024-01-01T00:00:00.000Z" }
    }
  },
  tvShows: {
    episodes: {
      "456_1": [1, 2, 3], // tvId_seasonNumber: [episodeNumbers]
    },
    seasonReviews: {
      "456_1": { rating: 5, review: "Great season!", date: "..." }
    },
    reviews: {
      "456": { want: true, watching: false }
    }
  },
  search: {
    recent: [...]
  },
  activity: [...]
}
```

## Решение проблем

### Проблема: Кнопки не реагируют после обновления

**Решение:**
```javascript
dataRepair.diagnose()  // Проверяем проблемы
dataRepair.repair()    // Исправляем
location.reload()      // Перезагружаем
```

### Проблема: Данные пользователя потеряны

**Решение:**
```javascript
dataRepair.listBackups()  // Смотрим доступные копии
dataRepair.restore('backup_key')  // Восстанавливаем
location.reload()
```

### Проблема: Ошибки в консоли о некорректной структуре

Это нормально при первой загрузке после обновления. Система автоматически исправляет данные. Если ошибки повторяются после перезагрузки:

```javascript
dataRepair.repair()
location.reload()
```

## Мониторинг

Следите за логами в консоли:
- `Миграция данных с версии X на Y` - началась миграция
- `Миграция завершена успешно` - миграция прошла успешно
- `Некорректная структура X, исправление...` - найдена и исправлена проблема
- `Создание нового хранилища` - создано чистое хранилище (новый пользователь)

## Тестирование

Перед релизом новой версии:

1. Создайте тестовые данные в старом формате
2. Запустите миграцию
3. Проверьте что все данные сохранились
4. Проверьте работу всех функций приложения
5. Проверьте логи на наличие ошибок

## Безопасность

- Миграция никогда не удаляет данные, только конвертирует
- При критических ошибках создается чистое хранилище
- Утилита `dataRepair` автоматически создает резервные копии
- Все операции логируются в консоль
