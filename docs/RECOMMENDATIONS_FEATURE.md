# Персонализированные рекомендации

## Описание
Новая секция "Для вас" / "For You" на страницах фильмов и сериалов, которая показывает персонализированные рекомендации на основе списков пользователя.

## Как работает

### Алгоритм рекомендаций

1. **Выбор базовых фильмов/сериалов:**
   - Берутся 3 случайных фильма/сериала из списков Want, Watched, Watching
   - Рандомизация обеспечивает разнообразие рекомендаций при каждом обновлении

2. **Получение рекомендаций:**
   - Для каждого выбранного фильма/сериала запрашиваются рекомендации через TMDB API
   - Используется эндпоинт `/movie/{id}/recommendations` или `/tv/{id}/recommendations`

3. **Фильтрация:**
   - Удаляются дубликаты
   - **Исключаются ВСЕ фильмы/сериалы по ID, которые уже есть в любых списках пользователя (Want/Watched/Watching)**
   - Фильтрация работает по ID, независимо от типа контента (movie/tv)
   - Это гарантирует, что пользователь видит только новый контент, который он еще не добавил

4. **Дополнение:**
   - Если после фильтрации осталось меньше 20 рекомендаций
   - Система автоматически запрашивает рекомендации для еще 2 случайных фильмов/сериалов
   - Продолжает до достижения лимита в 20 рекомендаций

5. **Сортировка:**
   - Рекомендации сортируются по формуле: `рейтинг × популярность`
   - Это обеспечивает баланс между качеством и актуальностью

### Автоматическое обновление

Рекомендации автоматически обновляются в следующих случаях:

1. **При каждом переходе на экран фильмов/сериалов:**
   - Кеш рекомендаций сбрасывается автоматически
   - Основные данные (trending, popular) остаются в кеше для быстрой загрузки
   - Рекомендации загружаются заново с учетом текущих списков пользователя

2. **При изменении списков пользователя:**
   - Пользователь добавляет фильм/сериал в Want
   - Пользователь добавляет фильм/сериал в Watched
   - Пользователь добавляет сериал в Watching
   - Пользователь удаляет что-то из списков
   - Реализовано через событие `movie-list-changed` из `UserDataStore`

Это обеспечивает, что рекомендации всегда актуальны и учитывают последние изменения в списках пользователя.

## Расположение секции

- **Фильмы:** между "Trending Now" и "Upcoming"
- **Сериалы:** между "Trending Now" и "Most Popular"

## Условия показа

Секция показывается только если:
- У пользователя есть хотя бы один фильм/сериал в списках
- Система смогла получить хотя бы одну рекомендацию

## Кэширование

### Фильмы
- Используется in-memory кэш `MoviesScreen._cache`
- Основные данные (trending, upcoming, popular) кэшируются до перезагрузки страницы
- **Рекомендации сбрасываются при каждом переходе на экран**
- Также инвалидируются при изменении списков пользователя

### Сериалы
- Используется localStorage с ключом `tvShowsData`
- Основные данные (trending, popular, top rated) кэшируются между сессиями
- **Рекомендации сбрасываются при каждом переходе на экран**
- Также инвалидируются при изменении списков пользователя

### Преимущества подхода:
- Быстрая загрузка основного контента (из кеша)
- Всегда свежие рекомендации (загружаются заново)
- Минимальная нагрузка на API (только рекомендации обновляются)

## Отладка

### Консольные команды:
```javascript
// Очистить кеш фильмов
clearMoviesCache()

// Очистить кеш сериалов
clearTVShowsCache()
```

### Логи в консоли:
- `Movies user lists:` - количество фильмов в списках
- `TV Shows user lists:` - количество сериалов в списках
- `Selected random movies/shows for recommendations:` - какие фильмы/сериалы выбраны
- `Filtered recommendations:` - сколько рекомендаций отфильтровано
- `recommended count:` - итоговое количество рекомендаций

## Файлы

### Основная логика:
- `src/services/tmdb.js` - методы `getPersonalizedRecommendations()` и `getPersonalizedTVRecommendations()`
- `src/services/user-data-store.js` - отправка события `movie-list-changed`

### UI:
- `src/pages/movies/movies-page.js` - секция рекомендаций для фильмов
- `src/pages/tvshows/shows-page.js` - секция рекомендаций для сериалов

### Переводы:
- `src/services/i18n.js` - ключ `forYou` (RU: "Для вас", EN: "For You")

## Преимущества подхода

1. **Персонализация:** рекомендации основаны на реальных предпочтениях пользователя
2. **Разнообразие:** рандомный выбор базовых фильмов обеспечивает разные рекомендации
3. **Актуальность:** автоматическое обновление при изменении списков
4. **Чистота:** исключение уже добавленных фильмов/сериалов
5. **Адаптивность:** система дополняет рекомендации если их недостаточно
