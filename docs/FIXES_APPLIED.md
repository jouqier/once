# Исправления логики кнопок сериалов

## Проблемы и решения

### Проблема 1: Mark all as Watched из состояния NONE
**Симптом**: После выбора "Mark all as Watched" кнопка сначала показывает "Watching", а при повторном заходе становится "Watched".

**Причина**: Конфликт между обработчиками событий. Метод `_handleChangeFromConstructor` реагировал на изменение чекбоксов и переводил сериал в состояние WATCHING, перезаписывая состояние WATCHED. Также дублирующийся слушатель `all-seasons-watched` вызывался дважды.

**Решение**:
1. Отключен обработчик `_handleChangeFromConstructor` (оставлен пустым)
2. Удален дублирующийся слушатель `all-seasons-watched` и `change` из connectedCallback/disconnectedCallback
3. Добавлен флаг `isBulkOperation` в событие `episode-checkbox-changed`
4. Обработчик `_handleEpisodeCheckboxChanged` теперь игнорирует массовые операции
5. Вся логика автоматических переходов для отдельных чекбоксов в `_handleEpisodeCheckboxChanged`

### Проблема 2: Снятие галки с одной серии
**Симптом**: После снятия галки с одной серии кнопка остается "Watched" вместо "Watching".

**Причина**: Проверка `wasAllWatched` выполнялась ПОСЛЕ изменения состояния чекбокса, а не ДО. Также дебаунс 300мс задерживал обновление состояния.

**Решение**:
1. Перенесена проверка `wasAllWatched` в начало обработчика (ДО изменения состояния)
2. Убран дебаунс (300мс задержка), который мешал корректной работе
3. Теперь событие `episode-checkbox-changed` отправляется с правильным значением `wasAllWatched`
4. Добавлен флаг `isBulkOperation: false` для отдельных чекбоксов

### Проблема 3: Mark as Unwatched не работает
**Симптом**: После нажатия "Mark as Unwatched" кнопка остается "Watched" вместо перехода в NONE.

**Причина**: Метод `_handleMarkAllUnwatched` переводил сериал в состояние WATCHING вместо NONE. Согласно логике, если все эпизоды не просмотрены, сериал должен быть в состоянии NONE.

**Решение**:
1. Изменена логика `_handleMarkAllUnwatched`: теперь переводит в состояние NONE
2. Удаляет сериал из списков WATCHED и WATCHING
3. Инвалидация кеша выполняется в правильном порядке

## Изменения в коде

### src/components/show-card-buttons.js

1. **connectedCallback**: Удалены дублирующиеся слушатели `all-seasons-watched` и `change`
2. **disconnectedCallback**: Удалены соответствующие removeEventListener
3. **_handleChangeFromConstructor**: Отключен, чтобы не конфликтовать с новой логикой
4. **_handleEpisodeCheckboxChanged**: Добавлена проверка флага `isBulkOperation` для игнорирования массовых операций
5. **_handleMarkAllUnwatched**: Изменена логика - теперь переводит в NONE вместо WATCHING

### src/components/show-card-seasons.js

1. **Обработчик чекбокса эпизода**: 
   - Проверка `wasAllWatched` перенесена в начало (ДО изменения)
   - Убран дебаунс (setTimeout 300мс)
   - Добавлен флаг `isBulkOperation: false` в событие

## Тестирование

### Сценарий 1: Mark all as Watched из NONE
1. Открыть карточку сериала (статус NONE)
2. Нажать на кнопку "Watched"
3. Выбрать "Mark all as Watched"
4. ✅ Кнопка должна показать "✓ Watched"
5. Закрыть и снова открыть карточку
6. ✅ Кнопка должна остаться "✓ Watched"

### Сценарий 2: Снятие галки с одной серии
1. Открыть карточку сериала (статус WATCHED, все серии просмотрены)
2. Снять галку с любой серии
3. ✅ Кнопка должна немедленно измениться на "Watching"
4. Закрыть и снова открыть карточку
5. ✅ Кнопка должна остаться "Watching"

### Сценарий 3: Mark as Unwatched
1. Открыть карточку сериала (статус WATCHED, один сезон)
2. Нажать кнопку "Mark as Unwatched" под сезоном
3. ✅ Должны отобразиться обе кнопки "Want" и "Watched" (статус NONE)
4. ✅ Все галки с эпизодов должны быть сняты
5. Закрыть и снова открыть карточку
6. ✅ Должны отображаться обе кнопки "Want" и "Watched"

## Ключевые принципы исправлений

1. **Проверка состояния ДО изменения**: Всегда проверяем `wasAllWatched` до изменения чекбокса
2. **Один источник истины**: Вся логика автоматических переходов в `_handleEpisodeCheckboxChanged`
3. **Разделение массовых и единичных операций**: Флаг `isBulkOperation` предотвращает конфликты
4. **Немедленное обновление**: Убран дебаунс для мгновенной реакции UI
5. **Правильные состояния**: Mark as Unwatched переводит в NONE, а не WATCHING
